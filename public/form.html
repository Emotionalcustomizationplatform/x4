<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application | Private Counsel</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* === Private Counsel Design System === */
            --bg: #050505; 
            --surface: #0a0a0a;
            --surface-card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            
            --gold: #E5C359;
            --gold-dim: #b89b44;
            --gold-glow: rgba(229, 195, 89, 0.15);
            --error: #ff4d4d;
            
            --radius: 12px;
        }

        /* === 基础布局 === */
        body { 
            background-color: var(--bg); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            overflow-x: hidden;
            background: radial-gradient(circle at 50% -20%, #1a1a2e 0%, #050505 50%);
        }

        .form-container { 
            width: 100%; max-width: 900px; padding: 2rem; 
            text-align: center; position: relative; z-index: 10; 
            padding-top: 4rem; 
        }

        /* === 步骤控制 === */
        .step { display: none; opacity: 0; }
        .step.active { display: block; opacity: 1; }
        
        .step-title { 
            font-family: 'Playfair Display', serif; 
            font-size: clamp(2rem, 5vw, 3.5rem); 
            font-weight: 500; 
            margin-bottom: 0.8rem; 
            letter-spacing: -0.02em; 
            color: #fff;
        }
        
        .step-subtitle { 
            color: var(--text-secondary); 
            margin-bottom: 3rem; 
            font-size: 1.05rem; 
            max-width: 600px; 
            margin-left: auto; margin-right: auto; 
            line-height: 1.6; font-weight: 300;
        }

        /* === 卡片选择网格 (无图标版) === */
        .selection-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 3rem; 
        }

        .selection-card {
            position: relative; 
            background: var(--surface-card); 
            backdrop-filter: blur(10px);
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            padding: 2.2rem 2rem; 
            cursor: pointer; 
            text-align: left; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* 核心设计：左侧隐形金条 */
            border-left: 3px solid transparent; 
        }

        .selection-card:hover { 
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
        }

        .selection-card.active {
            border-color: var(--gold);
            /* 激活时金条亮起 */
            border-left-color: var(--gold); 
            box-shadow: 0 0 40px rgba(229, 195, 89, 0.05);
            background: rgba(229, 195, 89, 0.03);
        }
        
        .card-title { font-size: 1.15rem; font-weight: 500; margin-bottom: 0.6rem; color: #fff; letter-spacing: 0.3px; }
        .card-desc { color: var(--text-secondary); line-height: 1.5; font-size: 0.9rem; margin: 0; font-weight: 300; }
        
        .card-price { margin-top: 1.5rem; font-size: 1.6rem; font-weight: 500; font-family: 'Playfair Display', serif; color: var(--gold); }
        .card-price .period { font-size: 0.9rem; color: var(--text-secondary); font-family: 'Inter', sans-serif; }

        .featured-badge { 
            position: absolute; top: 16px; right: 16px; 
            background: var(--gold); color: #000; 
            padding: 4px 10px; border-radius: 20px; 
            font-size: 0.7rem; font-weight: 700; 
            letter-spacing: 0.5px; text-transform: uppercase;
        }

        /* === 输入框 === */
        .input-box { max-width: 400px; margin: 0 auto; display: flex; flex-direction: column; gap: 16px; }
        
        .form-input { 
            width: 100%; 
            background: rgba(255, 255, 255, 0.05); 
            border: 1px solid var(--border); 
            padding: 16px; 
            font-size: 1rem; color: #fff; 
            border-radius: 8px; 
            transition: all 0.3s; 
            font-family: 'Inter', sans-serif; 
            box-sizing: border-box; 
        }

        .form-input::placeholder { color: rgba(255, 255, 255, 0.2); }
        .form-input:focus { 
            outline: none; border-color: var(--gold); 
            background: rgba(0,0,0,0.4);
            box-shadow: 0 0 20px var(--gold-glow);
        }

        /* === 按钮 === */
        .nav-bar { display: flex; justify-content: center; gap: 1rem; margin-top: 3rem; }
        
        .btn { 
            border: none; cursor: pointer; 
            padding: 16px 40px; border-radius: 50px; 
            font-weight: 600; font-size: 0.95rem; 
            transition: all 0.2s; 
            letter-spacing: 0.5px;
        }
        
        .btn-primary { background: var(--gold); color: #000; }
        .btn-primary:hover { background: #F0D069; transform: translateY(-1px); box-shadow: 0 4px 25px var(--gold-glow); }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        .btn-back { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 16px 30px; }
        .btn-back:hover { border-color: #fff; color: #fff; }

        /* === Toast 通知 === */
        .ref-toast {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: #000; border: 1px solid var(--gold); box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
            color: #fff; padding: 12px 24px; border-radius: 50px;
            display: flex; align-items: center; gap: 12px;
            z-index: 9999; opacity: 0; pointer-events: none; font-size: 0.85rem;
        }
        .ref-icon { color: var(--gold); display: flex; }
        .ref-code { font-weight: 700; color: var(--gold); letter-spacing: 1px; }
        .ref-close { background: none; border: none; color: #555; cursor: pointer; padding: 4px; display: flex; }
        .ref-close:hover { color: #fff; }

        .error-toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 77, 77, 0.9); color: white;
            padding: 10px 20px; border-radius: 8px; font-size: 0.9rem;
            z-index: 1000; opacity: 0; pointer-events: none;
        }

        #success { display: none; }
        #success .step-title { color: var(--gold); }
        
        /* === PayPal 容器动画 === */
        #paypal-wrapper {
            max-width: 400px; margin: 0 auto; 
            background: rgba(255,255,255,0.05); 
            padding: 24px; border-radius: 12px; 
            border: 1px solid var(--border);
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* 移动端优化 */
        @media (max-width: 768px) {
            .form-container { padding: 1.5rem; padding-top: 5rem; }
            .selection-grid { grid-template-columns: 1fr; gap: 16px; }
            .selection-card { padding: 1.5rem; display: flex; flex-direction: column; align-items: flex-start; text-align: left; }
            .card-desc { display: block; font-size: 0.85rem; opacity: 0.8; }
            .step-title { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

<!-- 引入 PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id=AeDpvr_Z_IjseYKwZNNfXYIYzkm3lgYyMBvmrMlfgF_8-gQ95XTE0FnoqH2rU3FjWf5VcMq1J1aMxaGT&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

<div class="form-container">
    <form id="bespokeForm">
        
        <!-- STEP 1: Plan Selection -->
        <div class="step active" id="step1">
            <h2 class="step-title">Choose Your Path</h2>
            <p class="step-subtitle">All relationships begin with a dialogue. Select an engagement level to proceed.</p>
            
            <div class="selection-grid">
                <!-- 第一张卡片 -->
                <div class="selection-card active" onclick="FormLogic.selectPlan('Initial Dialogue', '0', this)">
                    <div>
                        <div class="card-title">Initial Dialogue</div>
                        <p class="card-desc">A confidential 45-min session to assess your needs and chemistry.</p>
                    </div>
                    <div class="card-price">Free</div>
                </div>

                <!-- 第二张卡片 -->
                <div class="selection-card" onclick="FormLogic.selectPlan('Continuous Counsel', '710', this)">
                    <span class="featured-badge">Membership</span>
                    <div>
                        <div class="card-title">Continuous Counsel</div>
                        <p class="card-desc">Unlimited asynchronous strategic and emotional support.</p>
                    </div>
                    <div class="card-price">$710<span class="period">/mo</span></div>
                </div>
            </div>

            <input type="hidden" name="selected_plan" id="selected_plan" value="Initial Dialogue ($0)">
            <div class="nav-bar">
                <button type="button" class="btn btn-primary" onclick="FormLogic.nextStep(2)">Next Step</button>
            </div>
        </div>

        <!-- STEP 2: Priority Selection -->
        <div class="step" id="step2">
             <h2 class="step-title">Primary Focus</h2>
            <p class="step-subtitle">What is the most pressing challenge on your mind right now?</p>
            
            <input type="hidden" name="support_type" id="support_type">
            
            <div class="selection-grid">
                <div class="selection-card" onclick="FormLogic.selectOption('support_type', 'Psychological Strategy', this)">
                    <div>
                        <div class="card-title">Psychological Strategy</div>
                        <p class="card-desc">Navigate burnout, co-founder conflict, and high-stakes pressure.</p>
                    </div>
                </div>

                <div class="selection-card" onclick="FormLogic.selectOption('support_type', 'Emotional Support', this)">
                    <div>
                        <div class="card-title">Emotional Companion</div>
                        <p class="card-desc">A strictly private space to voice the unvoiceable.</p>
                    </div>
                </div>

                <div class="selection-card" onclick="FormLogic.selectOption('support_type', 'Mandarin Learning (HSK 8)', this)">
                    <div>
                        <div class="card-title">学习中文 (HSK 8级)</div>
                        <p class="card-desc">Mandarin nuance and cross-cultural negotiation tactics.</p>
                    </div>
                </div>
            </div>

            <div class="nav-bar">
                <button type="button" class="btn btn-back" onclick="FormLogic.prevStep(1)">Back</button>
                <button type="button" class="btn btn-primary" onclick="FormLogic.nextStep(3)">Continue</button>
            </div>
        </div>

        <!-- STEP 3: Secure Details -->
        <div class="step" id="step3">
            <h2 class="step-title">Secure Submission</h2>
            <p class="step-subtitle">Your details are encrypted. We will contact you shortly to schedule.</p>
            
            <div class="input-box">
                <input type="text" name="name" placeholder="Full Name" required autocomplete="name" class="form-input">
                <input type="email" name="email" placeholder="Email Address" required autocomplete="email" inputmode="email" class="form-input">
                <input type="tel" name="phone" placeholder="Phone / WhatsApp (Optional)" autocomplete="tel" inputmode="tel" class="form-input">
                <input type="hidden" name="referrer" id="referrerField">
                <input type="text" name="website_url" style="display:none" tabindex="-1" autocomplete="off" aria-hidden="true">
            </div>

            <div class="nav-bar">
                <button type="button" class="btn btn-back" onclick="FormLogic.prevStep(2)">Back</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Submit Request</button>
            </div>
        </div>
    </form>

    <!-- Success Screen -->
    <div id="success">
        <h2 class="step-title">Request Received</h2>
        <p class="step-subtitle" style="margin-bottom: 2rem;">Your application has been securely transmitted.<br>We will be in touch within 24 hours.</p>
        <div style="font-size: 0.9rem; color: #666; margin-bottom: 3rem;">Redirecting in <span id="countdown">5</span>s...</div>
        <a href="index.html" class="btn btn-back">Return Home</a>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
/* FormLogic Module */
const FormLogic = (() => {
    let currentStep = 1;
    const API_ENDPOINT = '/api/submit';
    
    // 动画函数 (保留不变)
    const animate = {
        in: (el) => { gsap.fromTo(el, { opacity: 0, y: 15, scale: 0.98, filter: 'blur(5px)' }, { opacity: 1, y: 0, scale: 1, filter: 'blur(0px)', duration: 0.6, ease: "power2.out" }); },
        out: (el, onComplete) => { gsap.to(el, { opacity: 0, y: -15, scale: 0.98, filter: 'blur(5px)', duration: 0.3, ease: "power2.in", onComplete: onComplete }); },
        shake: (el) => { gsap.fromTo(el, { x: -10 }, { x: 0, duration: 0.4, ease: "elastic.out(1, 0.3)" }); },
        toastIn: (el) => { gsap.to(el, { y: 0, opacity: 1, duration: 0.5, ease: "back.out(1.2)" }); },
        toastOut: (el) => { gsap.to(el, { y: -20, opacity: 0, duration: 0.3, ease: "power2.in", onComplete: () => el.remove() }); }
    };

    const showToast = (message, type = 'ref') => {
        const toast = document.createElement('div');
        if (type === 'error') {
            toast.className = 'error-toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            animate.toastIn(toast);
            setTimeout(() => animate.toastOut(toast), 3000);
            return;
        }
        toast.className = 'ref-toast';
        toast.innerHTML = `<span class="ref-icon"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span><span>Referral Applied: <span class="ref-code">${message}</span></span><button class="ref-close" aria-label="Close">&times;</button>`;
        let timer;
        const startTimer = () => { timer = setTimeout(() => animate.toastOut(toast), 5000); };
        toast.querySelector('.ref-close').onclick = () => { clearTimeout(timer); animate.toastOut(toast); };
        toast.onmouseenter = () => clearTimeout(timer);
        toast.onmouseleave = startTimer;
        document.body.appendChild(toast);
        animate.toastIn(toast);
        startTimer();
    };

    const validateStep = (step) => {
        if (step === 2 && !document.getElementById('support_type').value) {
            showToast("Please select a priority focus to continue.", 'error');
            animate.shake(document.querySelector('#step2 .selection-grid'));
            return false;
        }
        return true;
    };

    const changeStep = (direction) => {
        const targetStep = currentStep + direction;
        if (direction > 0 && !validateStep(currentStep)) return;
        const currentEl = document.getElementById('step' + currentStep);
        const nextEl = document.getElementById('step' + targetStep);
        animate.out(currentEl, () => {
            currentEl.classList.remove('active');
            nextEl.classList.add('active');
            animate.in(nextEl);
            currentStep = targetStep;
        });
    };

    const handleSelection = (groupSelector, inputId, value, element) => {
        document.querySelectorAll(groupSelector + ' .selection-card').forEach(c => c.classList.remove('active'));
        element.classList.add('active');
        document.getElementById(inputId).value = value;
    };

    // --- 核心初始化逻辑 (集成 PayPal) ---
    const init = () => {
        animate.in(document.getElementById('step1'));
        
        // 推荐码逻辑
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        if (refCode) {
            const safeRef = refCode.replace(/[^a-zA-Z0-9_]/g, ''); 
            document.getElementById('referrerField').value = safeRef;
            setTimeout(() => showToast(safeRef), 800);
        }

        const form = document.getElementById('bespokeForm');

        form.onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData);
            
            // 判断是否包含 '710'
            const isPaidPlan = payload.selected_plan.includes('710');

            btn.innerText = "Securing Connection...";
            btn.disabled = true;
            btn.style.opacity = "0.7";

            try {
                payload.submittedAt = new Date().toISOString();
                
                // 1. 发送数据到后台 (备份)
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    animate.out(form, () => {
                        form.style.display = 'none';

                        if (isPaidPlan) {
                            // === 付费版: 渲染 PayPal ===
                            const container = document.createElement('div');
                            container.id = 'paypal-wrapper';
                            // 动态创建一个容器
                            container.innerHTML = `
                                <h3 style="color:#fff; margin-bottom:1.5rem; font-family:'Playfair Display',serif; text-align:center;">Complete Membership</h3>
                                <p style="color:#aaa; font-size:0.9rem; text-align:center; margin-bottom:2rem;">Secure subscription setup via PayPal.</p>
                                <div id="paypal-button-container-P-2C4268778X3283126NF2UBHA"></div>
                            `;
                            document.querySelector('.form-container').appendChild(container);

                            // 渲染按钮
                            paypal.Buttons({
                                style: {
                                    shape: 'rect',
                                    color: 'gold', // 使用金色匹配主题
                                    layout: 'vertical',
                                    label: 'subscribe'
                                },
                                createSubscription: function(data, actions) {
                                    return actions.subscription.create({
                                        plan_id: 'P-2C4268778X3283126NF2UBHA'
                                    });
                                },
                                onApprove: function(data, actions) {
                                    // 支付成功
                                    container.style.display = 'none';
                                    const successEl = document.getElementById('success');
                                    successEl.querySelector('.step-subtitle').innerHTML = "Payment Confirmed.<br>Welcome to Private Counsel.";
                                    successEl.style.display = 'block';
                                    gsap.fromTo(successEl, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.8, ease: "back.out(1.5)" });
                                }
                            }).render('#paypal-button-container-P-2C4268778X3283126NF2UBHA');

                        } else {
                            // === 免费版: 直接显示成功 ===
                            const successEl = document.getElementById('success');
                            successEl.style.display = 'block';
                            gsap.fromTo(successEl, { opacity: 0, scale: 0.95 }, { opacity: 1, scale: 1, duration: 0.8, ease: "back.out(1.5)" });

                            let count = 5;
                            const counter = document.getElementById('countdown');
                            setInterval(() => {
                                count--;
                                if(count >= 0) counter.innerText = count;
                                if(count <= 0) window.location.href = 'index.html';
                            }, 1000);
                        }
                    });
                } else {
                    throw new Error('Server returned ' + response.status);
                }
            } catch (err) {
                console.error(err);
                showToast("Connection failed. Please try again.", 'error');
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        };
    };

    return {
        init,
        nextStep: () => changeStep(1),
        prevStep: () => changeStep(-1),
        selectPlan: (name, price, el) => { handleSelection('#step1', 'selected_plan', `${name} ($${price}/mo)`, el); },
        selectOption: (fieldId, value, el) => { handleSelection('#step2', fieldId, value, el); }
    };
})();
document.addEventListener('DOMContentLoaded', FormLogic.init);
</script>
</body>
</html>
